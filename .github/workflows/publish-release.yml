name: Publish Release ğŸ·ï¸

on:
  workflow_dispatch:

env:
  PRESET_VERSION: "1.4.0"   # <-- Change this when you want a new release

jobs:
  version-check:
    name: "Check preset version âš–ï¸"
    runs-on: ubuntu-22.04
    steps:
      - run: |
          if [[ ! "$PRESET_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: PRESET_VERSION is not a valid x.y.z version"
            exit 1
          fi
          echo "Using preset version: $PRESET_VERSION"

  draft-release:
    needs: version-check
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v5     # <-- REQUIRED

      - name: Create draft release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v$PRESET_VERSION" --draft --generate-notes

  build-release:
    needs: draft-release
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v5

      - name: Build and upload .deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y devscripts debhelper

          # Debian version must start with digit â†’ use PRESET_VERSION
          DEB_VER="${PRESET_VERSION}-1"

          rm -f debian/changelog
          dch --package quickemu --newversion="$DEB_VER" --distribution=unstable \
              "Preset upstream release" --create

          dpkg-buildpackage --build=binary --no-check-builddeps --compression=gzip

          gh release upload "v$PRESET_VERSION" "../quickemu_${DEB_VER}_all.deb" --clobber

  publish-release:
    needs: build-release
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v5     # <-- REQUIRED

      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit "v$PRESET_VERSION" --draft=false
